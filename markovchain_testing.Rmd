---
title: "Forest_Sequencing"
author: "Katie Murenbeeld"
date: "4/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro:

Testing out markov chain for picking a "typical" sequence of logging events in Southern Idaho timber harvest activities. 

```{r load_lib, echo=FALSE, eval=TRUE}
library(markovchain)
#library(dplyr)
library(tidyverse)
```

## Load data

```{r data, echo=FALSE, eval=TRUE}
df1 <- read.csv('test_proj1_20210601.csv')
df1$ACT <- as.character(df1$ACT)

df2 <- read.csv('test_proj2_20210601.csv')
df2$ACT <- as.character(df2$ACT)

df <- read.csv('proj_newcode2_20210419.csv')
#df <- df %>% rename(df, SEQ_INT = int)

df$ACRES <- as.numeric(df$ACRES)

head(df)
head(df1)
head(df2)

df3 <- rbind(df1, df2)
head(df3)
```

## Try out the createSequenceMatrix fuction

```{r seqmat_test1, echo=TRUE, eval=TRUE}
seqmat1 <- createSequenceMatrix(df1$ACT_TYPE, toRowProbs = TRUE, sanitize=TRUE)
seqmat1
```

```{r seqmat_test2, echo=TRUE, eval=TRUE}
seqmat2 <- createSequenceMatrix(df1$ACT, toRowProbs = TRUE, sanitize=TRUE)
seqmat2
```


```{r test_MCfit, echo=TRUE, eval=TRUE}
mcFitMLE <- markovchainFit(data = df$GEN_ACTIVITY)
summary(mcFitMLE)
```

```{r test_CTMC, echo=TRUE, eval=TRUE}
df_ctmc <- df %>% select(GEN_ACTIVITY, SEQ_INT)

ctmcFit(df_ctmc, byrow=TRUE, name="test_ctmc", confidencelevel = 0.95)
```

## This is fine, but I want to basically do this for each project? For each time an ACT_int is true? I guess I don't quite understand what the functions are doing.  I found a helpful tutorial to look into more: https://www.datacamp.com/community/tutorials/markov-chain-analysis-r as well as the cran documentation: https://cran.r-project.org/web/packages/markovchain/markovchain.pdf

```{r seq_verify, echo=TRUE, eval=TRUE}
seq <- unique(df$GEN_ACTIVITY)
seq

verifyMarkovProperty(seq)
```

```{r plot_test, echo=TRUE, eval=TRUE, fig.height=10, fig.width=15}
markov2 <- new('markovchain', 
               transitionMatrix = seqmat1,
               states = seq)
layout <- matrix(c(-8,-8, 0,9, -8,0, 8,1, 0,-8, -8,8, 9,8, 8,-8, 0,0, -4,4, 4,4, 4,-4), ncol = 2, byrow = TRUE)
plot(markov2, edge.arrow.size=0.5, vertex.size=10, vertex.label.cex = 0.5, edge.label.cex=0.75,
     vertex.color="green", edge.arrow.mode = 3, layout=layout)
```


```{r plot_test2, echo=TRUE, eval=TRUE, fig.height=10, fig.width=15}
seq1 <- unique(df1$ACT_TYPE)

seq2 <- unique(df1$ACT)
  

markov3 <- new('markovchain', 
               transitionMatrix = seqmat1,
               states = seq1)

markov4 <- new('markovchain', 
               transitionMatrix = seqmat2,
               states = seq2)
#layout <- matrix(c(-8,-8, 0,9, -8,0, 8,1, 0,-8, -8,8, 9,8, 8,-8, 0,0, -4,4, 4,4, 4,-4), ncol = 2, byrow = TRUE)
#plot(markov2, edge.arrow.size=0.5, vertex.size=10, vertex.label.cex = 0.5, edge.label.cex=0.75,
#     vertex.color="green", edge.arrow.mode = 3, layout=layout)

plot(markov3)
plot(markov4)
```
```{r plot_test3, echo=TRUE, eval=TRUE, fig.height=10, fig.width=15}
seqmat3 <- createSequenceMatrix(df2$ACT_TYPE, toRowProbs = TRUE, sanitize=TRUE)

seqmat4 <- createSequenceMatrix(df2$ACT, toRowProbs = TRUE, sanitize=TRUE)

seq3 <- unique(df2$ACT_TYPE)

seq4 <- unique(df2$ACT)
  

markov5 <- new('markovchain', 
               transitionMatrix = seqmat3,
               states = seq3)

markov6 <- new('markovchain', 
               transitionMatrix = seqmat4,
               states = seq4)
#layout <- matrix(c(-8,-8, 0,9, -8,0, 8,1, 0,-8, -8,8, 9,8, 8,-8, 0,0, -4,4, 4,4, 4,-4), ncol = 2, byrow = TRUE)
#plot(markov2, edge.arrow.size=0.5, vertex.size=10, vertex.label.cex = 0.5, edge.label.cex=0.75,
#     vertex.color="green", edge.arrow.mode = 3, layout=layout)

plot(markov5)
plot(markov6)
```

```{r plot_test4, echo=TRUE, eval=TRUE, fig.height=10, fig.width=15}
seqmat5 <- createSequenceMatrix(df3$ACT_TYPE, toRowProbs = TRUE, sanitize=TRUE)

seqmat6 <- createSequenceMatrix(df3$ACT, toRowProbs = TRUE, sanitize=TRUE)

seq5 <- unique(df3$ACT_TYPE)

seq6 <- unique(df3$ACT)
  

markov7 <- new('markovchain', 
               transitionMatrix = seqmat5,
               states = seq5)

markov8 <- new('markovchain', 
               transitionMatrix = seqmat6,
               states = seq6)
#layout <- matrix(c(-8,-8, 0,9, -8,0, 8,1, 0,-8, -8,8, 9,8, 8,-8, 0,0, -4,4, 4,4, 4,-4), ncol = 2, byrow = TRUE)
#plot(markov2, edge.arrow.size=0.5, vertex.size=10, vertex.label.cex = 0.5, edge.label.cex=0.75,
#     vertex.color="green", edge.arrow.mode = 3, layout=layout)

plot(markov7)
plot(markov8)
```

## I think I want to first, test out how to subset by project, and then try to do the subsetting in a loop. Somehow I want to get the transition matrices for each project. Still need to figure out how to get the time of the transitions. According to the datacamp markovchain in R "Transition matrices have the property that

```{r subset, echo=TRUE, eval=TRUE}
projects <- unique(df$NEPA_PROJECT)

proj1 <- subset(df, NEPA_PROJECT == projects[5])
#proj1

proj1_seq <- createSequenceMatrix(proj1$GEN_ACTIVITY, toRowProbs = TRUE, sanitize=TRUE)
proj1_seq
proj1
```
```{r loop_test, echo=TRUE, eval=TRUE}
projects <- unique(df$NEPA_PROJECT)

##for (x in projects) {
#  print(x)
#}

for (x in projects) {
  proj <- subset(df, NEPA_PROJECT == x)
  return(proj)
  proj_seq <- createSequenceMatrix(proj$SEQ_ACTIVITY, toRowProbs = TRUE, sanitize=TRUE)
  return(proj_seq)
}

proj_seq
```
```{r markov3, echo=TRUE, eval=TRUE}
markov3 <- new("markovchain", 
               states = c("EA-RH-FH", "INT_CUT"),
               transitionMatrix = proj1_seq,
               name = "test")
markov3
```

```{r mean_recur_time, echo=TRUE, eval=TRUE}
meantest <- meanRecurrenceTime(markov2)
meantest
```
```{r data_out_test, echo=TRUE, eval=TRUE}
mcDf <- as(markov3, "data.frame")
#mcNew <- as(mcDf, "markovchain")
mcDf
```

